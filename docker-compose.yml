services:

  database:

    image: postgres:15-alpine

    container_name: database

    environment:

      POSTGRES_DB: saas_db

      POSTGRES_USER: postgres

      POSTGRES_PASSWORD: postgres

    ports:

      - "5432:5432" # Fixed external:internal port mapping

    volumes:

      - db_data:/var/lib/postgresql/data

      # Map individual files to ensure alphabetical execution order

      - ./database/migrations/001_create_tenants.sql:/docker-entrypoint-initdb.d/01_tenants.sql

      - ./database/migrations/002_create_users.sql:/docker-entrypoint-initdb.d/02_users.sql

      - ./database/migrations/003_create_projects_and_tasks.sql:/docker-entrypoint-initdb.d/03_projects.sql

      - ./database/migrations/004_create_audit_logs.sql:/docker-entrypoint-initdb.d/04_audit.sql

      - ./database/seeds/seed_data.sql:/docker-entrypoint-initdb.d/05_seed.sql

    healthcheck:

      test: ["CMD-SHELL", "pg_isready -U postgres"]

      interval: 10s

      timeout: 5s

      retries: 5



  backend:

    build: ./backend

    container_name: backend

    ports:

      - "5000:5000" # Fixed external:internal port mapping

    environment:

      DB_HOST: database

      DB_PORT: 5432

      DB_NAME: saas_db

      DB_USER: postgres

      DB_PASSWORD: postgres

      JWT_SECRET: super-secret-key-12345

      FRONTEND_URL: http://frontend:3000

    depends_on:

      database:

        condition: service_healthy # Mandatory dependency check

    healthcheck:

      test: ["CMD", "curl", "-f", "http://localhost:5000/api/health"] # Mandatory health check

      interval: 10s

      timeout: 5s

      retries: 5



  frontend:

    build: ./frontend

    container_name: frontend

    ports:

      - "3000:3000" # Fixed external:internal port mapping

    environment:

      - REACT_APP_API_URL=http://localhost:5000/api

    depends_on:

      backend:

        condition: service_healthy



volumes:

  db_data: